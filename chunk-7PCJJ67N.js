import{Bc as d,Pe as O,Yc as w,Z as u,a as l,bd as T,ca as y,da as v,ea as x,fa as h,ga as E,hd as n,ia as B,j as a,l as N,s as m,w as g}from"./chunk-SBXYWWID.js";var I=(()=>{let r=class r{};r.\u0275fac=function(e){return new(e||r)},r.\u0275mod=B({type:r}),r.\u0275inj=v({});let o=r;return o})();var b=new x("DC_STORE_STORAGE_TOKEN",{providedIn:"root",factory:()=>new c(E(n))}),c=class{constructor(r){this.platform=r}get(r){return this.platform.isBrowser&&JSON.parse(localStorage.getItem(r)||"null")||null}set(r,M){return this.platform.isBrowser&&localStorage.setItem(r,JSON.stringify(M)),!0}remove(r){this.platform.isBrowser&&localStorage.removeItem(r)}};var $=(()=>{let r=class r{constructor(t,e,i,s){this.store=e,this.http=i,this.platform=s,this.memory=new Map,this.notifyBuffer=new Map,this.meta=new Set,this.freqTick=3e3,this.cog=t.merge("cache",{mode:"promise",reName:"",prefix:"",meta_key:"__cache_meta"}),s.isBrowser&&(this.loadMeta(),this.startExpireNotify())}pushMeta(t){this.meta.has(t)||(this.meta.add(t),this.saveMeta())}removeMeta(t){this.meta.has(t)&&(this.meta.delete(t),this.saveMeta())}loadMeta(){let t=this.store.get(this.cog.meta_key);t&&t.v&&t.v.forEach(e=>this.meta.add(e))}saveMeta(){let t=[];this.meta.forEach(e=>t.push(e)),this.store.set(this.cog.meta_key,{v:t,e:0})}getMeta(){return this.meta}set(t,e,i={}){if(!this.platform.isBrowser)return;let s=0,{type:f,expire:j}=this.cog;i=l({type:f,expire:j},i),i.expire&&(s=O(new Date,i.expire).valueOf());let p=i.emitNotify!==!1;if(!(e instanceof a)){this.save(i.type,t,{v:e,e:s},p);return}return e.pipe(u(S=>{this.save(i.type,t,{v:S,e:s},p)}))}save(t,e,i,s=!0){t==="m"?this.memory.set(e,i):(this.store.set(this.cog.prefix+e,i),this.pushMeta(e)),s&&this.runNotify(e,"set")}get(t,e={}){if(!this.platform.isBrowser)return null;let i=e.mode!=="none"&&this.cog.mode==="promise",s=this.memory.has(t)?this.memory.get(t):this.store.get(this.cog.prefix+t);return!s||s.e&&s.e>0&&s.e<new Date().valueOf()?i?(this.cog.request?this.cog.request(t):this.http.get(t)).pipe(g(f=>w(f,this.cog.reName,f)),u(f=>this.set(t,f,{type:e.type,expire:e.expire,emitNotify:e.emitNotify}))):null:i?m(s.v):s.v}getNone(t){return this.get(t,{mode:"none"})}tryGet(t,e,i={}){if(!this.platform.isBrowser)return null;let s=this.getNone(t);return s===null?e instanceof a?this.set(t,e,i):(this.set(t,e,i),e):m(s)}has(t){return this.memory.has(t)||this.meta.has(t)}_remove(t,e){if(e&&this.runNotify(t,"remove"),this.memory.has(t)){this.memory.delete(t);return}this.store.remove(this.cog.prefix+t),this.removeMeta(t)}remove(t){this.platform.isBrowser&&this._remove(t,!0)}clear(){this.platform.isBrowser&&(this.notifyBuffer.forEach((t,e)=>this.runNotify(e,"remove")),this.memory.clear(),this.meta.forEach(t=>this.store.remove(this.cog.prefix+t)))}set freq(t){this.freqTick=Math.max(20,t),this.abortExpireNotify(),this.startExpireNotify()}startExpireNotify(){this.checkExpireNotify(),this.runExpireNotify()}runExpireNotify(){this.freqTime=setTimeout(()=>{this.checkExpireNotify(),this.runExpireNotify()},this.freqTick)}checkExpireNotify(){let t=[];this.notifyBuffer.forEach((e,i)=>{this.has(i)&&this.getNone(i)===null&&t.push(i)}),t.forEach(e=>{this.runNotify(e,"expire"),this._remove(e,!1)})}abortExpireNotify(){clearTimeout(this.freqTime)}runNotify(t,e){this.notifyBuffer.has(t)&&this.notifyBuffer.get(t).next({type:e,value:this.getNone(t)})}notify(t){if(!this.notifyBuffer.has(t)){let e=new N(this.getNone(t));this.notifyBuffer.set(t,e)}return this.notifyBuffer.get(t).asObservable()}cancelNotify(t){this.notifyBuffer.has(t)&&(this.notifyBuffer.get(t).unsubscribe(),this.notifyBuffer.delete(t))}hasNotify(t){return this.notifyBuffer.has(t)}clearNotify(){this.notifyBuffer.forEach(t=>t.unsubscribe()),this.notifyBuffer.clear()}ngOnDestroy(){this.memory.clear(),this.abortExpireNotify(),this.clearNotify()}};r.\u0275fac=function(e){return new(e||r)(h(T),h(b),h(d),h(n))},r.\u0275prov=y({token:r,factory:r.\u0275fac,providedIn:"root"});let o=r;return o})();export{$ as a,I as b};
