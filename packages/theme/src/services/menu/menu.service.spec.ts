import { Injector } from '@angular/core';
import { TestBed, async, inject } from '@angular/core/testing';
import { filter } from 'rxjs/operators';

import { ACLService } from '@delon/acl';
import {
  ALAIN_I18N_TOKEN,
  AlainI18NServiceFake,
} from '../i18n/i18n';
import { deepCopy } from '@delon/util';

import { Menu } from './interface';
import { MenuService } from './menu.service';

class MockACLService {
  can(val: string) {
    return val === 'admin';
  }
}

describe('Service: Menu', () => {
  let injector: Injector;
  let srv: MenuService;
  const DATA = [
    {
      text: 'dashboard',
      link: '/dashboard',
      children: [
        { text: 'v1', link: '/dashboard/v1' },
        { text: 'v2', link: '/dashboard/v2' },
      ],
    },
    {
      text: 'text',
      children: [{ text: 'sub text', link: '/text/sub', shortcut: true }],
    },
    { text: 'text', link: '/test', linkExact: true, badge: 10 },
    {
      text: 'text',
      link: '/demo1',
      badge: 10,
      badge_dot: true,
      badge_status: 'success',
    },
    { text: 'text', externalLink: '//ng-alain.com' },
    { text: 'text', link: '/demo2', i18n: 'text' },
    { text: 'sub', children: [] },
  ];

  describe('[default]', () => {
    beforeEach(() => {
      injector = TestBed.configureTestingModule({
        providers: [
          MenuService,
          { provide: ALAIN_I18N_TOKEN, useClass: AlainI18NServiceFake },
          { provide: ACLService, useClass: MockACLService },
        ],
      });
      srv = injector.get(MenuService);
    });

    afterEach(() => srv.ngOnDestroy());

    it('should create an instance', () => {
      expect(srv).toBeTruthy();
    });

    it('#add', () => {
      srv.add(deepCopy(DATA));
      expect(srv.menus.length).toBe(DATA.length);
    });

    it('#resume', () => {
      srv.add(deepCopy(DATA));
      let tick = 0;
      srv.resume(item => ++tick);
      expect(tick).toBeGreaterThan(0);
    });

    it('#clear', () => {
      srv.add(deepCopy(DATA));
      expect(srv.menus.length).toBe(DATA.length);
      srv.clear();
      expect(srv.menus.length).toBe(0);
    });

    it('should be hidden item when setting [hide] property', () => {
      const newMenus = [{ text: 'new menu' }, { text: 'new menu', hide: true }];
      srv.add(newMenus);
      expect(srv.menus[0]._hidden).toBe(false);
      expect(srv.menus[1]._hidden).toBe(true);
    });

    it('should be hidden group name when setting [group] property', () => {
      const newMenus = [{ text: 'new menu' }, { text: 'new menu', group: false }];
      srv.add(newMenus);
      expect(srv.menus[0].group).toBe(true);
      expect(srv.menus[1].group).toBe(false);
    });

    describe('#openedByUrl', () => {
      it('with url', () => {
        srv.add(deepCopy(DATA));
        srv.openedByUrl(`/dashboard/v1`);
        expect(srv.menus[0]._open).toBe(true);
      });
      it('not found', () => {
        srv.add(deepCopy(DATA));
        srv.openedByUrl(`/notfound`);
        expect(srv.menus.filter(w => w._open === false).length).toBe(
          srv.menus.length,
        );
      });
      it('invalid url', () => {
        srv.add(deepCopy(DATA));
        srv.openedByUrl(null);
        expect(srv.menus.filter(w => w._open === false).length).toBe(0);
      });
    });

    describe('#getPathByUrl', () => {
      it('with url', () => {
        srv.add(deepCopy(DATA));
        const menus = srv.getPathByUrl(`/dashboard/v1`);
        expect(menus.length).toBe(2);
        expect(menus[0].text).toBe('dashboard');
      });
      it('invalid url', () => {
        srv.add(deepCopy(DATA));
        const menus = srv.getPathByUrl(`/dashboard/v1111`);
        expect(menus.length).toBe(0);
      });
    });

    describe('#shortcuts', () => {
      it('should be under the dashboard', () => {
        srv.add(deepCopy(DATA));
        expect(srv.menus[0].children[1].children.length).toBe(1);
      });
      it('should be use [shortcut_root: true]', () => {
        const newMenus = <Menu[]>[
          {
            text: 'new menu',
            children: [
              { text: 'submenu1', link: '/' },
              { text: 'submenu2', link: '/' },
              { text: 'sc', shortcut_root: true },
            ],
          },
          {
            text: 'text',
            children: [{ text: 'sub text', link: '/text/sub', shortcut: true }],
          },
        ];
        srv.add(newMenus);
        expect(srv.menus[0].children[2].children.length).toBe(1);
      });
      it('should be under zero node', () => {
        const newMenus = <Menu[]>[
          {
            text: 'new menu',
            i18n: 'test',
          },
          {
            text: 'text',
            children: [{ text: 'sub text', link: '/text/sub', shortcut: true }],
          },
        ];
        srv.add(newMenus);
        expect(srv.menus[0].children[0].children.length).toBe(1);
      });
    });

    it('ACL', () => {
      const newMenus = [
        { text: 'new menu', acl: 'admin' },
        { text: 'new menu', acl: 'user' },
      ];
      srv.add(newMenus);
      expect(srv.menus[0]._hidden).toBe(false);
      expect(srv.menus[1]._hidden).toBe(true);
      srv.ngOnDestroy();
    });

    it('#change', (done: () => void) => {
      const newMenus = [{ text: 'new menu' }];
      srv.change.pipe(filter(ls => ls.length > 0)).subscribe(res => {
        expect(res.length).toBe(1);
        expect(res[0].text).toBe(newMenus[0].text);
        srv.ngOnDestroy();
        done();
      });
      srv.add(newMenus);
    });

    describe('ISSUES', () => {
      it('ng-alain #107', () => {
        srv.add(deepCopy(DATA));
        expect(
          srv.menus[0].children.filter(w => w.shortcut_root === true).length,
        ).toBe(1);
        expect(srv.menus[0].children[1].children.length).toBe(1);
        srv.resume();
        expect(
          srv.menus[0].children.filter(w => w.shortcut_root === true).length,
        ).toBe(1);
        expect(srv.menus[0].children[1].children.length).toBe(1);
      });
    });
  });

  describe('[i18n changed]', () => {
    it('with ALAIN_I18N_TOKEN', () => {
      injector = TestBed.configureTestingModule({
        providers: [
          MenuService,
          { provide: ALAIN_I18N_TOKEN, useClass: AlainI18NServiceFake },
          { provide: ACLService, useClass: MockACLService },
        ],
      });
      srv = injector.get(MenuService);
      spyOn(srv, 'resume');
      expect(srv.resume).not.toHaveBeenCalled();
      injector.get(ALAIN_I18N_TOKEN).use('en');
      expect(srv.resume).toHaveBeenCalled();
      srv.ngOnDestroy();
    });

    it('without ALAIN_I18N_TOKEN', () => {
      injector = TestBed.configureTestingModule({
        providers: [
          MenuService,
          { provide: ACLService, useClass: MockACLService },
        ],
      });
      srv = injector.get(MenuService);
      srv.ngOnDestroy();
      expect(true).toBe(true);
    });
  });
});
